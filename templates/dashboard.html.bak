<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>武器库 - PUBG 武器管理系统</title>
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #1a202c; color: #a0aec0; margin: 0; padding: 1rem; }
        .container { max-width: 1200px; margin: auto; background: #2d3748; padding: 2rem; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); animation: fadeIn 0.5s ease-out; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4a5568; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .header h1 { color: #e2e8f0; margin: 0; }
        .header button { padding: 0.5rem 1rem; border-radius: 4px; background-color: #c53030; color: white; cursor: pointer; border: none; transition: background-color 0.3s; }
        .header button:hover { background-color: #9b2c2c; }
        .controls { display: flex; justify-content: space-between; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .controls input, .controls button { padding: 0.75rem; border-radius: 4px; border: 1px solid #4a5568; background-color: #1a202c; color: #e2e8f0; }
        .controls button { background-color: #3182ce; cursor: pointer; border: none; transition: background-color 0.3s; }
        .controls button:hover { background-color: #2b6cb0; }
        .grid-container { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 120px; width: 100%; margin-top: 1rem; }
        .grid-header { display: contents; }
        .grid-row { display: contents; }
        .grid-cell { border-bottom: 1px solid #4a5568; padding: 1rem; text-align: left; word-wrap: break-word; overflow: hidden; }
        .header-cell { background-color: #1a202c; cursor: pointer; user-select: none; font-weight: bold; }
        .header-cell:hover { background-color: #4a5568; }
        .grid-container .grid-row:hover .grid-cell { background-color: #4a5568; }

        .th-content { display: flex; align-items: center; width: 100%; }
        .th-content > span:first-child { flex-grow: 1; }
        .sort-arrows { display: flex; flex-direction: column; line-height: 0.8; width: 12px; flex-shrink: 0; }
        .sort-arrows span { opacity: 0.2; transition: opacity 0.2s; }
        .header-cell.asc .arrow-up, .header-cell.desc .arrow-down { opacity: 1; color: #63b3ed; }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .grid-header {
                display: none;
            }
            .grid-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem 1rem;
                padding: 1rem;
                border: 1px solid #4a5568;
                border-radius: 8px;
            }
            .grid-cell {
                border-bottom: none;
                padding: 0;
                display: flex;
                flex-direction: column;
            }
            .grid-cell:before {
                content: attr(data-label);
                font-weight: bold;
                margin-bottom: 0.25rem;
                opacity: 0.7;
                font-size: 0.8em;
            }
            .grid-cell.actions {
                grid-column: 1 / -1; /* Span full width */
                flex-direction: row;
                justify-content: flex-end;
                margin-top: 0.5rem;
            }
        }
        .actions { width: 120px; }
        .actions button { margin-right: 0.5rem; padding: 0.25rem 0.5rem; border: none; border-radius: 4px; cursor: pointer; transition: transform 0.2s; }
        .actions button:hover { transform: scale(1.1); }
        .btn-edit { background-color: #dd6b20; color: white; }
        .btn-delete { background-color: #c53030; color: white; }
        
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #2d3748; margin: 10% auto; padding: 2rem; border: 1px solid #4a5568; width: 90%; max-width: 500px; border-radius: 8px; animation: fadeIn 0.3s; }
        .close { color: #a0aec0; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #weaponForm label { display: block; margin-bottom: 0.5rem; }
        #weaponForm input { width: 100%; box-sizing: border-box; padding: 0.75rem; border-radius: 4px; border: 1px solid #4a5568; background-color: #1a202c; color: #e2e8f0; margin-bottom: 1rem; }
        #weaponForm button { width: 100%; padding: 0.75rem; border-radius: 4px; border: none; background-color: #3182ce; color: white; cursor: pointer; }
        .version-indicator { position: fixed; bottom: 10px; right: 10px; background: #c53030; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 9999; }
    </style>
</head>
<body>
    <div class="version-indicator">版本号: {{ version }}</div>
    <div class="container">
        <div class="header">
            <h1 id="welcomeMessage">武器库</h1>
            <button id="logoutBtn">退出登录</button>
        </div>
        <div class="controls">
            <input type="text" id="searchInput" placeholder="按名称搜索...">
            <button id="addWeaponBtn">添加新武器</button>
        </div>
        <div id="gridContainer" class="grid-container">
            <div id="tableHeader" class="grid-header">
                <div class="grid-cell header-cell" data-sort="name"><div class="th-content"><span>名称</span><div class="sort-arrows"><span class="arrow-up">▲</span><span class="arrow-down">▼</span></div></div></div>
                <div class="grid-cell header-cell" data-sort="damage"><div class="th-content"><span>伤害</span><div class="sort-arrows"><span class="arrow-up">▲</span><span class="arrow-down">▼</span></div></div></div>
                <div class="grid-cell header-cell" data-sort="fire_rate"><div class="th-content"><span>射速</span><div class="sort-arrows"><span class="arrow-up">▲</span><span class="arrow-down">▼</span></div></div></div>
                <div class="grid-cell header-cell" data-sort="capacity"><div class="th-content"><span>弹夹容量</span><div class="sort-arrows"><span class="arrow-up">▲</span><span class="arrow-down">▼</span></div></div></div>
                <div class="grid-cell header-cell" data-sort="ammo"><div class="th-content"><span>当前弹药</span><div class="sort-arrows"><span class="arrow-up">▲</span><span class="arrow-down">▼</span></div></div></div>
                <div class="grid-cell header-cell actions">操作</div>
            </div>
            <div id="weaponTableBody" class="grid-body"></div>
        </div>
    </div>

    <div id="weaponModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">添加武器</h2>
            <form id="weaponForm">
                <input type="hidden" id="originalName">
                <label>名称: <input type="text" id="name" required></label>
                <label>伤害: <input type="number" id="damage" required></label>
                <label>射速: <input type="number" step="0.001" id="fire_rate" required></label>
                <label>弹夹容量: <input type="number" id="capacity" required></label>
                <label>当前弹药: <input type="number" id="ammo" required></label>
                <button type="submit">保存</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = localStorage.getItem('loggedInUser');
            if (!currentUser) {
                window.location.href = '/login';
                return;
            }

            document.getElementById('welcomeMessage').textContent = `${currentUser}的武器库`;
            
            let weapons = [];
            let currentSort = { key: 'name', direction: 'asc' };

            const tableBody = document.getElementById('weaponTableBody'); // This now acts as a container for rows
            const gridContainer = document.getElementById('gridContainer');
            const searchInput = document.getElementById('searchInput');
            const addWeaponBtn = document.getElementById('addWeaponBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const tableHeader = document.getElementById('tableHeader');
            
            const modal = document.getElementById('weaponModal');
            const modalTitle = document.getElementById('modalTitle');
            const weaponForm = document.getElementById('weaponForm');
            const closeModalBtn = document.querySelector('.close');

            const fetchWeapons = async () => {
                try {
                    const response = await fetch('/api/weapons', { headers: { 'X-Username': currentUser }});
                    if (!response.ok) throw new Error('获取武器失败');
                    const data = await response.json();
                    weapons = data.weapons;
                    renderTable();
                } catch (error) { alert(error.message); }
            };

            const renderTable = () => {
                let displayWeapons = [...weapons];
                if (searchInput.value) {
                    displayWeapons = displayWeapons.filter(w => w.name.toLowerCase().includes(searchInput.value.toLowerCase()));
                }

                displayWeapons.sort((a, b) => {
                    const valA = a[currentSort.key];
                    const valB = b[currentSort.key];
                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                document.querySelectorAll('#tableHeader .header-cell[data-sort]').forEach(cell => {
                    cell.classList.remove('asc', 'desc');
                    if (cell.dataset.sort === currentSort.key) {
                        cell.classList.add(currentSort.direction);
                    }
                });
                
                // Clear previous rows
                while (tableBody.firstChild) {
                    tableBody.removeChild(tableBody.firstChild);
                }

                const fragment = document.createDocumentFragment();
                displayWeapons.forEach(weapon => {
                    const row = document.createElement('div');
                    row.className = 'grid-row';
                    row.innerHTML = `
                        <div class="grid-cell" data-label="名称">${weapon.name}</div>
                        <div class="grid-cell" data-label="伤害">${weapon.damage}</div>
                        <div class="grid-cell" data-label="射速">${weapon.fire_rate}</div>
                        <div class="grid-cell" data-label="弹夹容量">${weapon.capacity}</div>
                        <div class="grid-cell" data-label="当前弹药">${weapon.ammo}</div>
                        <div class="grid-cell actions" data-label="操作">
                            <button class="btn-edit" data-name="${weapon.name}">编辑</button>
                            <button class="btn-delete" data-name="${weapon.name}">删除</button>
                        </div>
                    `;
                    fragment.appendChild(row);
                });
                tableBody.appendChild(fragment);
            };

            const openModal = (mode, weapon = null) => {
                weaponForm.reset();
                modalTitle.textContent = mode === 'add' ? '添加新武器' : '编辑武器';
                document.getElementById('originalName').value = weapon ? weapon.name : '';
                if (weapon) {
                    document.getElementById('name').value = weapon.name;
                    document.getElementById('damage').value = weapon.damage;
                    document.getElementById('fire_rate').value = weapon.fire_rate;
                    document.getElementById('capacity').value = weapon.capacity;
                    document.getElementById('ammo').value = weapon.ammo;
                }
                modal.style.display = 'block';
            };

            searchInput.addEventListener('input', renderTable);
            addWeaponBtn.addEventListener('click', () => openModal('add'));
            closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('loggedInUser');
                window.location.href = '/login';
            });
            window.addEventListener('click', e => { if (e.target == modal) modal.style.display = 'none'; });

            tableHeader.addEventListener('click', e => {
                const sortKey = e.target.closest('.header-cell')?.dataset.sort;
                if (sortKey) {
                    if (currentSort.key === sortKey) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.key = sortKey;
                        currentSort.direction = 'asc';
                    }
                    renderTable();
                }
            });

            weaponForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const originalName = document.getElementById('originalName').value;
                const isEdit = !!originalName;
                const weaponData = {
                    name: document.getElementById('name').value,
                    damage: parseFloat(document.getElementById('damage').value),
                    fire_rate: parseFloat(document.getElementById('fire_rate').value),
                    capacity: parseInt(document.getElementById('capacity').value),
                    ammo: parseInt(document.getElementById('ammo').value)
                };
                
                const url = isEdit ? `/api/weapons/${originalName}` : '/api/weapons';
                try {
                    const response = await fetch(url, {
                        method: isEdit ? 'PUT' : 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Username': currentUser },
                        body: JSON.stringify(weaponData)
                    });
                    if (!response.ok) throw new Error('操作失败');
                    modal.style.display = 'none';
                    fetchWeapons();
                } catch (error) { alert(error.message); }
            });

            gridContainer.addEventListener('click', async (e) => {
                const weaponName = e.target.dataset.name;
                if (e.target.classList.contains('btn-delete')) {
                    if (confirm(`确定删除 ${weaponName} 吗？`)) {
                        try {
                            const response = await fetch(`/api/weapons/${weaponName}`, {
                                method: 'DELETE', headers: { 'X-Username': currentUser }
                            });
                            if (!response.ok) throw new Error('删除失败');
                            fetchWeapons();
                        } catch (error) { alert(error.message); }
                    }
                } else if (e.target.classList.contains('btn-edit')) {
                    const weapon = weapons.find(w => w.name === weaponName);
                    if (weapon) openModal('edit', weapon);
                }
            });

            fetchWeapons();
        });
    </script>
</body>
</html>