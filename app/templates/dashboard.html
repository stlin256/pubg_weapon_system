<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê≠¶Âô®Â∫ì - PUBG Ê≠¶Âô®ÁÆ°ÁêÜÁ≥ªÁªü</title>
    <!-- ÂºïÂÖ•Â≠ó‰Ωì -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <!-- ÂºïÂÖ• Chart.js -->
    <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
    <style>
        /* --- ÂÖ®Â±ÄÂèòÈáèÂÆö‰πâ --- */
        :root {
            --orange: #f2a900; --dark-bg: #14151a; --panel-bg: #1e2126; --border-color: #383b42;
            --text-main: #e2e8f0; --text-muted: #a0aec0; --danger: #e84118; --blue: #3182ce;
            --lang-zh-color: #c53030; --lang-en-color: #2b6cb0;
        }

        /* --- Âä®ÁîªÂÆö‰πâ --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes loadProgress { 0% { left: -50%; } 100% { left: 100%; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* --- Âü∫Á°ÄÊ†∑Âºè --- */
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Roboto', sans-serif; background-color: #0f1014; color: var(--text-main);
            margin: 0; padding: 0; min-height: 100vh;
            background-image: linear-gradient(0deg, rgba(15,16,20,0.95) 0%, rgba(15,16,20,0.8) 100%), url("{{ url_for('static', filename='img/dashboard-bg.jpg') }}");
            background-attachment: fixed; background-size: cover;
        }
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; animation: fadeIn 0.5s ease-out; }

        /* --- È°∂ÈÉ®ÂØºËà™Ê†è --- */
        .header {
            display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 0;
            margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); position: relative;
        }
        .header::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100px; height: 2px; background: var(--orange); box-shadow: 0 0 10px var(--orange); }
        .header h1 { font-family: 'Oswald', sans-serif; margin: 0; font-size: 2rem; text-transform: uppercase; letter-spacing: 2px; color: #fff; }
        .user-tag { font-size: 0.9rem; color: var(--orange); font-family: 'Roboto Mono', monospace; margin-left: 10px; opacity: 0.8; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        
        /* --- ‰∏ªÂØºËà™ËèúÂçï --- */
        .main-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }
        .nav-tab {
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            position: relative;
            color: var(--text-muted);
            transition: color 0.3s;
        }
        .nav-tab.active {
            color: var(--orange);
        }
        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--orange);
            transform: scaleX(0);
            transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .nav-tab.active::after {
            transform: scaleX(1);
        }
        @media (max-width: 600px) {
            .main-nav {
                gap: 0.5rem;
            }
            .nav-tab {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
        }


        /* --- ÊåâÈíÆÊ†∑Âºè --- */
        .btn {
            padding: 0.6rem 1.2rem; border-radius: 2px; cursor: pointer; border: none;
            font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s; font-weight: 600; white-space: nowrap; 
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-logout { background-color: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-add { background-color: var(--orange); color: #000; }
        .btn-edit { background-color: #2f3640; color: #fff; border: 1px solid #7f8fa6; margin-right: 5px; }
        .btn-delete { background-color: rgba(232, 65, 24, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        
        @media (hover: hover) {
            .btn-logout:hover { background-color: var(--danger); color: white; }
            .btn-add:hover { background-color: #ffc107; transform: scale(1.05); }
            .btn-edit:hover { background-color: #fff; color: #000; }
            .btn-delete:hover { background-color: var(--danger); color: white; }
        }
        .btn:active { transform: scale(0.96); opacity: 0.8; }

        /* --- ÊéßÂà∂Ê†è‰∏éË°®Ê†º --- */
        .controls {
            display: flex; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;
            background: rgba(30, 33, 38, 0.6); padding: 1rem; border-radius: 4px; border-left: 3px solid var(--orange);
        }
        .search-box input {
            padding: 0.75rem 1rem; border-radius: 2px; border: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.5); color: #fff; width: 250px; font-family: 'Roboto Mono', monospace;
        }
        .search-box input:focus { outline: none; border-color: var(--orange); }
        
        .grid-container {
            display: grid; 
            grid-template-columns: 2fr 1fr 1.5fr 1fr 1fr 1fr 160px; 
            background: rgba(20, 20, 25, 0.7); border: 1px solid var(--border-color);
        }
        .grid-header { display: contents; font-family: 'Oswald', sans-serif; color: var(--text-muted); font-size: 0.9rem; letter-spacing: 1px; }
        .header-cell {
            background-color: #15171c; padding: 1rem; border-bottom: 2px solid var(--border-color);
            cursor: pointer; display: flex; align-items: center; transition: color 0.2s;
            user-select: none; -webkit-user-select: none;
        }
        .grid-row { display: contents; }
        .grid-cell { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; font-family: 'Roboto Mono', monospace; font-size: 0.95rem; }
        @media (hover: hover) {
            .grid-row:hover .grid-cell { background-color: rgba(242, 169, 0, 0.05); }
            .header-cell:hover { color: var(--orange); }
        }

        /* --- ÂèØËßÜÂåñÁªÑ‰ª∂ --- */
        .stat-bar { width: 60px; height: 4px; background: #333; margin-left: 10px; display: inline-block; border-radius: 2px; overflow: hidden; vertical-align: middle; }
        .stat-fill { height: 100%; background: var(--orange); box-shadow: 0 0 5px var(--orange); }
        .sort-arrows { display: flex; flex-direction: column; margin-left: 8px; gap: 2px; }
        .arrow { width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; opacity: 0.3; }
        .arrow-up { border-bottom: 4px solid currentColor; }
        .arrow-down { border-top: 4px solid currentColor; }
        .header-cell.asc .arrow-up, .header-cell.desc .arrow-down { opacity: 1; color: var(--orange); }
        .firing-mode-tags { display: flex; gap: 5px; flex-wrap: wrap; }
        .mode-tag { padding: 2px 8px; font-size: 0.75rem; border-radius: 3px; font-family: 'Roboto Mono', monospace; text-transform: uppercase; border: 1px solid; }
        .mode-tag.single { border-color: #4299e1; color: #63b3ed; background-color: rgba(66, 153, 225, 0.1); }
        .mode-tag.auto { border-color: #d53f8c; color: #ed64a6; background-color: rgba(237, 100, 166, 0.1); }

        /* --- ÁßªÂä®Á´ØÂìçÂ∫îÂºè --- */
        @media (max-width: 900px) {
            .grid-container { display: block; background: transparent; border: none; }
            .grid-header { display: none; }
            .grid-row { display: block; background: #1e2126; margin-bottom: 1rem; border-radius: 4px; border-left: 3px solid #383b42; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.1s; user-select: none; -webkit-user-select: none; }
            .grid-row:active { transform: scale(0.98); border-left-color: var(--orange); }
            .grid-cell { padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.03); justify-content: space-between; display: flex; }
            .cell-content { display: flex; align-items: center; justify-content: flex-end; text-align: right; }
            .grid-cell[data-label="name"] { font-family: 'Oswald', sans-serif; font-size: 1.4rem; color: #fff; border-bottom: 1px solid var(--border-color); margin-bottom: 0.5rem; padding-bottom: 0.5rem; }
            .grid-cell[data-label="name"]:before { display: none; }
            .grid-cell:before { content: attr(data-mobile-label); color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; font-weight: bold; margin-right: 1rem; }
            .grid-cell.actions { margin-top: 1rem; justify-content: flex-end; border-top: 1px solid var(--border-color); padding-top: 1rem; border-bottom: none; gap: 10px; }
            .grid-cell.actions:before { display: none; }
            .controls { flex-direction: column; }
            .search-box input { width: 100%; box-sizing: border-box; }
        }

        /* --- ÂºπÁ™ó‰∏éË°®Âçï --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: #1e2126; margin: 10% auto; padding: 2rem; border: 1px solid var(--border-color); width: 85%; max-width: 500px; box-shadow: 0 0 30px rgba(0,0,0,0.5); animation: fadeIn 0.3s; position: relative; }
        .modal-content::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--orange); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; padding: 0 10px; }
        .close:hover { color: var(--orange); }
        #modalTitle { margin-top: 0; color: #fff; font-family: 'Oswald', sans-serif; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .form-row { margin-bottom: 1.5rem; position: relative; } 
        .form-row label { display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem; }
        .form-row input[type="text"], .form-row input[type="number"] { width: 100%; padding: 0.8rem; background: #0f1014; border: 1px solid var(--border-color); color: white; font-family: 'Roboto Mono', monospace; box-sizing: border-box; transition: border-color 0.3s; }
        .form-row input:focus { outline: none; border-color: var(--orange); }
        
        /* --- È™åËØÅÊèêÁ§∫Ê†∑Âºè (‰ºòÂåñÁâà) --- */
        .form-row input.error { border-color: var(--danger); animation: shake 0.3s ease-in-out; }
        .pubg-tooltip {
            position: absolute; 
            top: 100%; /* ÊòæÁ§∫Âú®‰∏ãÊñπ */
            right: 0; 
            margin-top: 8px; /* ‰∏ãÊñπÈó¥Ë∑ù */
            background-color: rgba(232, 65, 24, 0.9); 
            color: white;
            padding: 4px 8px; 
            font-size: 0.75rem; 
            font-family: 'Oswald', sans-serif; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            border-radius: 2px; 
            border: 1px solid var(--danger);
            pointer-events: none; 
            opacity: 0; 
            transform: translateY(-5px); 
            transition: all 0.2s; 
            z-index: 10;
        }
        .pubg-tooltip.visible { opacity: 1; transform: translateY(0); }
        /* Ê∞îÊ≥°Â∞èÁÆ≠Â§¥ (Âêë‰∏äÊåá) */
        .pubg-tooltip::after {
            content: ''; position: absolute; 
            bottom: 100%; /* Âú®Ê∞îÊ≥°‰∏äÊñπ */
            right: 10px;
            border-width: 5px; border-style: solid;
            border-color: transparent transparent var(--danger) transparent; /* Á∫¢Ëâ≤‰∏âËßíÂΩ¢Âêë‰∏ä */
        }

        .tag-selector { display: flex; gap: 10px; padding: 0.8rem; background: #0f1014; border-radius: 4px; border: 1px solid var(--border-color); min-height: 23px; align-items: center;}
        .tag-option { padding: 3px 10px; font-size: 0.9em; border: 1px solid var(--border-color); color: var(--text-muted); border-radius: 4px; cursor: pointer; transition: all 0.2s; user-select: none; }
        .tag-option.active.single { background-color: rgba(66, 153, 225, 0.2); color: #63b3ed; border-color: #4299e1; }
        .tag-option.active.auto { background-color: rgba(237, 100, 166, 0.2); color: #ed64a6; border-color: #d53f8c; }
        .btn-save { width: 100%; padding: 1rem; background: var(--orange); color: black; font-weight: bold; margin-top: 1rem; }
        .version-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-family: 'Roboto Mono', monospace;
            font-size: 12px;
            color: rgba(255,255,255,0.3);
            pointer-events: none;
            z-index: 1001;
        }
        
        #confirmModal .modal-content { max-width: 400px; text-align: center; }
        #confirmText { font-family: 'Oswald', sans-serif; color: var(--text-main); margin-bottom: 1.5rem; font-size: 1.2rem; text-transform: uppercase; }
        .confirm-actions { display: flex; justify-content: center; gap: 1rem; }
        .btn-confirm { background-color: var(--danger); color: white; }
        .btn-cancel { background-color: #4a5568; color: white; }

        /* --- ËØ≠Ë®ÄÂàáÊç¢Âô® (‰ºòÂåñÁâà) --- */
        .lang-switcher {
            position: relative; display: flex; align-items: center;
            width: 80px; height: 28px;
            border-radius: 4px; cursor: pointer;
            font-family: 'Oswald', sans-serif; overflow: hidden;
            transition: all 0.2s;
            filter: grayscale(100%); /* ÈªòËÆ§ÈªëÁôΩÁÅ∞ */
            opacity: 0.7;
        }
        
        /* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊÅ¢Â§çËâ≤ÂΩ©ÂíåÈ´ò‰∫Æ */
        @media (hover: hover) { 
            .lang-switcher:hover { 
                transform: scale(1.05); 
                filter: grayscale(0%); 
                opacity: 1;
            } 
        }

        .lang-switcher span { flex: 1; text-align: center; z-index: 2; transition: color 0.4s; font-size: 0.9em; }
        .lang-switcher .lang-option { color: var(--text-muted); }
        .lang-switcher .active { color: #fff; }
        
        .lang-switcher .glider {
            position: absolute; top: 0; left: 0;
            width: 50%; height: 100%; z-index: 1;
            clip-path: polygon(15% 0, 100% 0, 85% 100%, 0% 100%);
            transition: transform 0.4s cubic-bezier(0.77, 0, 0.175, 1);
        }
        .lang-switcher.zh .glider { background: var(--lang-zh-color); box-shadow: 0 0 10px var(--lang-zh-color); transform: translateX(0); }
        .lang-switcher.en .glider { background: var(--lang-en-color); box-shadow: 0 0 10px var(--lang-en-color); transform: translateX(100%); }

        /* --- ËØ≠Ë®ÄÂàáÊç¢Âä†ËΩΩÈÅÆÁΩ© --- */
        #languageLoader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #0f1014; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #languageLoader.active { opacity: 1; pointer-events: auto; }
        .loader-text {
            font-family: 'Oswald', sans-serif; color: var(--orange);
            font-size: 1.5rem; letter-spacing: 3px;
            animation: blink 0.8s infinite;
        }
        .loader-bar {
            width: 200px; height: 2px; background: #333; margin-top: 15px; position: relative; overflow: hidden;
        }
        .loader-progress {
            position: absolute; top: 0; left: 0; height: 100%; width: 50%;
            background: var(--orange); animation: loadProgress 1s infinite linear;
        }

        #back-to-top {
            position: fixed; bottom: 33.33vh; right: 20px;
            width: 45px; height: 45px; background: rgba(45, 55, 72, 0.8);
            color: var(--orange); border: 1px solid var(--border-color); border-radius: 4px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; font-weight: bold; opacity: 0; pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
        }
        #back-to-top.visible { opacity: 0.8; pointer-events: auto; }
        #back-to-top:hover { opacity: 1; transform: scale(1.1); background: var(--orange); color: black; }
        
        /* --- Êû™Â£∞ËØÜÂà´Ê®°Âùó‰∏ìÂ±ûÊ†∑Âºè --- */
        .rec-section { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 2rem; }
        .rec-section-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 0.75rem; }
        .rec-section-header h2 { font-family: 'Oswald', sans-serif; margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; color: var(--orange); }
        .rec-section-body { padding: 1.5rem; }
        .preferences-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .pref-group label { display: block; font-family: 'Oswald', sans-serif; color: var(--text-muted); margin-bottom: 0.5rem; }
        .pref-group select { width: 100%; padding: 0.75rem; background: #0f1014; border: 1px solid var(--border-color); color: white; font-family: 'Roboto Mono', monospace; border-radius: 2px; }
        .upload-area { border: 2px dashed var(--border-color); border-radius: 4px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s; margin-top: 1.5rem; background-color: rgba(0,0,0,0.2); }
        .upload-area.dragover { border-color: var(--orange); background-color: rgba(242, 169, 0, 0.1); }
        .upload-icon { font-size: 3rem; color: var(--orange); }
        .upload-text { margin-top: 1rem; color: var(--text-muted); }
        .results-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-top: 1.5rem; }
        .result-card { background: #0f1014; border: 1px solid var(--border-color); padding: 1.5rem; text-align: center; border-radius: 4px; }
        .result-card h3 { margin: 0 0 0.5rem 0; font-family: 'Oswald', sans-serif; color: var(--text-muted); text-transform: uppercase; }
        .result-card p { margin: 0; font-family: 'Roboto Mono', monospace; font-size: 1.5rem; color: var(--orange); min-height: 2rem; }
        .chart-controls { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; }
        .chart-toggle-btn { background: var(--panel-bg); color: var(--text-muted); border: 1px solid var(--border-color); }
        .chart-toggle-btn.active { background: var(--orange); color: black; border-color: var(--orange); }
    </style>
</head>
<body>
    <div class="version-indicator">{{ version }}</div>
    
    <!-- ËØ≠Ë®ÄÂàáÊç¢ÈÅÆÁΩ© -->
    <div id="languageLoader">
        <div class="loader-text">SYSTEM RELOAD...</div>
        <div class="loader-bar"><div class="loader-progress"></div></div>
    </div>

    <div class="container">
        <!-- Â§¥ÈÉ®Âå∫Âüü -->
        <div class="header">
            <div><h1 id="welcomeTitle"></h1><span id="welcomeUser" class="user-tag"></span></div>
            <div class="header-actions">
                <div id="lang-switcher" class="lang-switcher">
                    <span class="lang-option" data-lang="zh">‰∏≠</span>
                    <span class="lang-option" data-lang="en">EN</span>
                    <div class="glider"></div>
                </div>
                <button id="logoutBtn" class="btn btn-logout"></button>
            </div>
        </div>

        <!-- ‰∏ªÂØºËà™ËèúÂçï -->
        <div class="main-nav">
            <div class="nav-tab active" data-tab="armory">Ê≠¶Âô®Â∫ì</div>
            <div class="nav-tab" data-tab="recognition">Êû™Â£∞ËØÜÂà´</div>
        </div>

        <!-- Èù¢ÊùøÂÆπÂô® -->
        <div id="armory-panel" class="panel-content">
            <!-- Êìç‰ΩúÊéßÂà∂Ê†è -->
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="">
                </div>
                <button id="addWeaponBtn" class="btn btn-add"></button>
            </div>

            <!-- Ê≠¶Âô®Êï∞ÊçÆË°®Ê†º -->
            <div id="gridContainer" class="grid-container">
                <div id="tableHeader" class="grid-header">
                    <!-- ÂàóÊ†áÈ¢ò -->
                    <div class="header-cell" data-sort="name"><span data-t="colName"></span> <div class="sort-arrows"><div class="arrow arrow-up"></div><div class="arrow arrow-down"></div></div></div>
                    <div class="header-cell" data-sort="damage"><span data-t="colDmg"></span> <div class="sort-arrows"><div class="arrow arrow-up"></div><div class="arrow arrow-down"></div></div></div>
                    <div class="header-cell" data-sort="firing_mode"><span data-t="colMode"></span> <div class="sort-arrows"><div class="arrow arrow-up"></div><div class="arrow arrow-down"></div></div></div>
                    <div class="header-cell" data-sort="capacity"><span data-t="colCap"></span> <div class="sort-arrows"><div class="arrow arrow-up"></div><div class="arrow arrow-down"></div></div></div>
                    <div class="header-cell" data-sort="mag_count"><span data-t="colMags"></span> <div class="sort-arrows"><div class="arrow arrow-up"></div><div class="arrow arrow-down"></div></div></div>
                    <div class="header-cell" data-sort="ammo_in_mag"><span data-t="colAmmo"></span> <div class="sort-arrows"><div class="arrow arrow-up"></div><div class="arrow arrow-down"></div></div></div>
                    <div class="header-cell actions-header" data-t="colAct"></div>
                </div>
            </div>
        </div>

        <div id="recognition-panel" class="panel-content" style="display: none;">
            <!-- Êû™Â£∞ËØÜÂà´ UI -->
            <div class="rec-section">
                <div class="rec-section-header">
                    <h2>Ê®°ÂûãÂÅèÂ•ΩËÆæÁΩÆ</h2>
                </div>
                <div class="rec-section-body">
                    <div class="preferences-grid">
                        <div class="pref-group">
                            <label for="weapon_model_select">Ê≠¶Âô®ËØÜÂà´Ê®°Âûã</label>
                            <select id="weapon_model_select"></select>
                        </div>
                        <div class="pref-group">
                            <label for="distance_model_select">Ë∑ùÁ¶ªËØÜÂà´Ê®°Âûã</label>
                            <select id="distance_model_select"></select>
                        </div>
                        <div class="pref-group">
                            <label for="direction_model_select">ÊñπÂêëËØÜÂà´Ê®°Âûã</label>
                            <select id="direction_model_select"></select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rec-section">
                <div class="rec-section-header">
                    <h2>Èü≥È¢ëÂàÜÊûê</h2>
                </div>
                <div class="rec-section-body">
                    <input type="file" id="audio-upload-input" accept="audio/*" style="display: none;">
                    <div id="upload-area" class="upload-area">
                        <div class="upload-icon">üéµ</div>
                        <div class="upload-text">ÊãñÊãΩÈü≥È¢ëÊñá‰ª∂Ëá≥Ê≠§ÔºåÊàñÁÇπÂáªÈÄâÊã©</div>
                    </div>
                    <div id="results-grid" class="results-grid">
                        <div class="result-card">
                            <h3>Ê≠¶Âô®Á±ªÂûã</h3>
                            <p id="result-weapon">-</p>
                        </div>
                        <div class="result-card">
                            <h3>ÂºÄÁÅ´Ë∑ùÁ¶ª</h3>
                            <p id="result-distance">-</p>
                        </div>
                        <div class="result-card">
                            <h3>Â£∞Ê∫êÊñπÂêë</h3>
                            <p id="result-direction">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="rec-section">
                <div class="rec-section-header">
                    <h2>Ê®°ÂûãÊÄßËÉΩÂèÇËÄÉ (Benchmark)</h2>
                </div>
                <div class="rec-section-body">
                    <div class="chart-controls">
                        <button class="btn chart-toggle-btn active" data-metric="accuracy">ÂáÜÁ°ÆÁéá</button>
                        <button class="btn chart-toggle-btn" data-metric="f1-score (macro)">F1 ÂàÜÊï∞</button>
                    </div>
                    <canvas id="benchmark-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæë ÂºπÁ™ó -->
    <div id="weaponModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle"></h2>
            <form id="weaponForm" novalidate>
                <input type="hidden" id="originalName">
                <div class="form-row">
                    <label data-t-label="name"></label>
                    <input type="text" id="name" required>
                    <div class="pubg-tooltip">NAME REQUIRED</div>
                </div>
                <div class="form-row">
                    <label data-t-label="dmg"></label>
                    <input type="number" id="damage" required min="0">
                    <div class="pubg-tooltip">NUMERIC ONLY</div>
                </div>
                <div class="form-row">
                    <label data-t-label="mode"></label>
                    <div id="firingModeSelector" class="tag-selector">
                        <div class="tag-option single" data-mode="single"></div>
                        <div class="tag-option auto" data-mode="auto"></div>
                    </div>
                </div>
                <div class="form-row">
                    <label data-t-label="cap"></label>
                    <input type="number" id="capacity" required min="1">
                    <div class="pubg-tooltip">INVALID CAPACITY</div>
                </div>
                <div class="form-row">
                    <label data-t-label="mags"></label>
                    <input type="number" id="mag_count" required min="0">
                    <div class="pubg-tooltip">NUMERIC ONLY</div>
                </div>
                <div class="form-row">
                    <label data-t-label="ammo"></label>
                    <input type="number" id="ammo_in_mag" required min="0">
                    <div class="pubg-tooltip">NUMERIC ONLY</div>
                </div>
                <button type="submit" id="btnSave" class="btn btn-save"></button>
            </form>
        </div>
    </div>

    <!-- Á°ÆËÆ§Êìç‰ΩúÂºπÁ™ó -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <p id="confirmText"></p>
            <div class="confirm-actions">
                <button id="btnConfirmDelete" class="btn btn-confirm"></button>
                <button id="btnCancelDelete" class="btn btn-cancel"></button>
            </div>
        </div>
    </div>

    <button id="back-to-top">‚¨Ü</button>

    <script>
        // --- ÂõΩÈôÖÂåñËµÑÊ∫ê ---
        const i18n = {
            'zh': {
                title: 'Ê≠¶Âô®Â∫ì', op: 'Êìç‰ΩúÂëò', logout: 'ÈÄÄÂá∫ÁôªÂΩï', search: 'ÊêúÁ¥¢Ê≠¶Âô®...', add: '+ ÈÉ®ÁΩ≤Ê≠¶Âô®',
                navArmory: 'Ê≠¶Âô®Â∫ì', navRecognition: 'Êû™Â£∞ËØÜÂà´',
                rec: {
                    prefs: 'Ê®°ÂûãÂÅèÂ•ΩËÆæÁΩÆ', weapon: 'Ê≠¶Âô®ËØÜÂà´Ê®°Âûã', distance: 'Ë∑ùÁ¶ªËØÜÂà´Ê®°Âûã', direction: 'ÊñπÂêëËØÜÂà´Ê®°Âûã',
                    analysis: 'Èü≥È¢ëÂàÜÊûê', upload: 'ÊãñÊãΩÈü≥È¢ëÊñá‰ª∂Ëá≥Ê≠§ÔºåÊàñÁÇπÂáªÈÄâÊã©',
                    results: 'ÂàÜÊûêÁªìÊûú', resWeapon: 'Ê≠¶Âô®Á±ªÂûã', resDistance: 'ÂºÄÁÅ´Ë∑ùÁ¶ª', resDirection: 'Â£∞Ê∫êÊñπÂêë',
                    benchmark: 'Ê®°ÂûãÊÄßËÉΩÂèÇËÄÉ (Benchmark)', acc: 'ÂáÜÁ°ÆÁéá', f1: 'F1 ÂàÜÊï∞'
                },
                colName: 'ÂêçÁß∞', colDmg: '‰º§ÂÆ≥', colMode: 'ÂºÄÁÅ´Ê®°Âºè', colCap: 'ÂºπÂÆπ', colMags: 'ÂºπÂ§πÊï∞', colAmmo: 'Êû™ÂÜÖÂ≠êÂºπ', colAct: 'Êìç‰Ωú',
                modalAdd: 'ÈÉ®ÁΩ≤Êñ∞Ê≠¶Âô®', modalEdit: '‰øÆÊîπÈÖçÁΩÆ',
                labels: { name: 'Ê≠¶Âô®ÂêçÁß∞', dmg: 'Âü∫Á°Ä‰º§ÂÆ≥', mode: 'ÂºÄÁÅ´Ê®°Âºè', cap: 'ÂºπÂ§πÂÆπÈáè', mags: 'Â§áÁî®ÂºπÂ§πÊï∞', ammo: 'Êû™ÂÜÖÂΩìÂâçÂ≠êÂºπ' },
                modes: { single: 'ÂçïÁÇπ', auto: 'ËøûÂ∞Ñ' },
                btnSave: '‰øùÂ≠òÈÖçÁΩÆ', btnEdit: 'ÁºñËæë', btnDel: 'Âà†Èô§', confirmDel: 'Á°ÆËÆ§ÈîÄÊØÅÊ≠¶Âô®Ôºö', confirmLogout: 'Á°ÆËÆ§ÈÄÄÂá∫ÁôªÂΩïÔºü',
                btnConfirm: 'Á°ÆËÆ§', btnCancel: 'ÂèñÊ∂à',
                errors: { required: 'Ê≠§È°πÂøÖÂ°´', number: '‰ªÖÈôêÊï∞Â≠ó', loading: 'Á≥ªÁªüÈáçËΩΩ‰∏≠...' }
            },
            'en': {
                title: 'ARMORY', op: 'OPERATOR', logout: 'LOGOUT', search: 'SEARCH WEAPON...', add: '+ DEPLOY WEAPON',
                navArmory: 'Armory', navRecognition: 'Recognition',
                rec: {
                    prefs: 'Model Preferences', weapon: 'Weapon Recognition Model', distance: 'Distance Recognition Model', direction: 'Direction Recognition Model',
                    analysis: 'Audio Analysis', upload: 'Drag & drop audio file here, or click to select',
                    results: 'Analysis Results', resWeapon: 'Weapon Type', resDistance: 'Firing Distance', resDirection: 'Sound Direction',
                    benchmark: 'Model Performance Benchmark', acc: 'Accuracy', f1: 'F1-Score'
                },
                colName: 'NAME', colDmg: 'DAMAGE', colMode: 'FIRING MODE', colCap: 'CAPACITY', colMags: 'MAGS', colAmmo: 'AMMO IN GUN', colAct: 'ACTIONS',
                modalAdd: 'DEPLOY NEW WEAPON', modalEdit: 'MODIFY CONFIG',
                labels: { name: 'WEAPON NAME', dmg: 'BASE DAMAGE', mode: 'FIRING MODE', cap: 'MAG CAPACITY', mags: 'MAG COUNT', ammo: 'AMMO IN MAG' },
                modes: { single: 'Single', auto: 'Auto' },
                btnSave: 'SAVE CONFIGURATION', btnEdit: 'EDIT', btnDel: 'DELETE', confirmDel: 'CONFIRM DECOMMISSION: ', confirmLogout: 'CONFIRM LOGOUT?',
                btnConfirm: 'CONFIRM', btnCancel: 'CANCEL',
                errors: { required: 'REQUIRED', number: 'NUMERIC ONLY', loading: 'SYSTEM RELOAD...' }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Ëé∑ÂèñÁî®Êà∑ËØ≠Ë®ÄÂÅèÂ•Ω
            let currentLang = localStorage.getItem('lang') || (navigator.language.startsWith('zh') ? 'zh' : 'en');
            let t = i18n[currentLang];
            
            // ÁôªÂΩïÊ†°È™å
            const currentUser = localStorage.getItem('loggedInUser');
            if (!currentUser) { window.location.href = '/login'; return; }
            
            // DOM ÂÖÉÁ¥†ÂºïÁî®
            const langSwitcher = document.getElementById('lang-switcher');
            const langLoader = document.getElementById('languageLoader');
            const loaderText = langLoader.querySelector('.loader-text');
            const gridContainer = document.getElementById('gridContainer');
            const searchInput = document.getElementById('searchInput');
            const weaponModal = document.getElementById('weaponModal');
            const confirmModal = document.getElementById('confirmModal');
            const backToTopBtn = document.getElementById('back-to-top');
            const mainNav = document.querySelector('.main-nav');

            // --- Êû™Â£∞ËØÜÂà´Ê®°Âùó DOM ÂÖÉÁ¥† ---
            const recognitionPanel = document.getElementById('recognition-panel');
            const weaponSelect = document.getElementById('weapon_model_select');
            const distanceSelect = document.getElementById('distance_model_select');
            const directionSelect = document.getElementById('direction_model_select');
            const uploadArea = document.getElementById('upload-area');
            const audioUploadInput = document.getElementById('audio-upload-input');
            const resultWeapon = document.getElementById('result-weapon');
            const resultDistance = document.getElementById('result-distance');
            const resultDirection = document.getElementById('result-direction');
            const benchmarkChartCanvas = document.getElementById('benchmark-chart');
            const chartControls = document.querySelector('.chart-controls');
            
            // --- Êû™Â£∞ËØÜÂà´Ê®°ÂùóÊï∞ÊçÆÂ≠òÂÇ® ---
            let availableModels = {};
            let benchmarkData = [];
            let benchmarkChart = null;
            let currentMetric = 'accuracy';
            let sortedData = [];


            // --- ÂØºËà™ÂàáÊç¢ÈÄªËæë ---
            mainNav.addEventListener('click', (e) => {
                if (e.target.classList.contains('nav-tab')) {
                    const targetTab = e.target.dataset.tab;

                    // Êõ¥Êñ∞ Tab ÊøÄÊ¥ªÁä∂ÊÄÅ
                    mainNav.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');

                    // ÂàáÊç¢Èù¢ÊùøÊòæÁ§∫
                    document.querySelectorAll('.panel-content').forEach(panel => {
                        panel.style.display = panel.id === `${targetTab}-panel` ? 'block' : 'none';
                    });
                }
            });

            // --- Ê†∏ÂøÉÂáΩÊï∞ÔºöÂ∫îÁî®Â§öËØ≠Ë®Ä ---
            const applyTranslations = () => {
                t = i18n[currentLang];
                // Êõ¥Êñ∞ÂàáÊç¢Âô®Ê†∑Âºè
                langSwitcher.classList.remove('zh', 'en');
                langSwitcher.classList.add(currentLang);
                document.querySelectorAll('.lang-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.lang === currentLang);
                });

                // Êõ¥Êñ∞ÂØºËà™ËèúÂçï
                document.querySelector('.nav-tab[data-tab="armory"]').textContent = t.navArmory;
                document.querySelector('.nav-tab[data-tab="recognition"]').textContent = t.navRecognition;

                // Êõ¥Êñ∞ÈùôÊÄÅÊñáÊú¨
                document.querySelectorAll('[data-t]').forEach(el => { el.textContent = t[el.dataset.t]; });
                
                // --- Êñ∞Â¢ûÔºöÊû™Â£∞ËØÜÂà´Ê®°ÂùóÁöÑÂõΩÈôÖÂåñ ---
                const recPanel = document.getElementById('recognition-panel');
                recPanel.querySelector('h2').textContent = t.rec.prefs;
                recPanel.querySelector('label[for="weapon_model_select"]').textContent = t.rec.weapon;
                recPanel.querySelector('label[for="distance_model_select"]').textContent = t.rec.distance;
                recPanel.querySelector('label[for="direction_model_select"]').textContent = t.rec.direction;
                recPanel.querySelectorAll('h2')[1].textContent = t.rec.analysis;
                recPanel.querySelector('.upload-text').textContent = t.rec.upload;
                recPanel.querySelectorAll('.result-card h3')[0].textContent = t.rec.resWeapon;
                recPanel.querySelectorAll('.result-card h3')[1].textContent = t.rec.resDistance;
                recPanel.querySelectorAll('.result-card h3')[2].textContent = t.rec.resDirection;
                recPanel.querySelectorAll('h2')[2].textContent = t.rec.benchmark;
                recPanel.querySelector('.chart-toggle-btn[data-metric="accuracy"]').textContent = t.rec.acc;
                recPanel.querySelector('.chart-toggle-btn[data-metric="f1-score (macro)"]').textContent = t.rec.f1;
                document.querySelectorAll('[data-t-label]').forEach(el => { el.textContent = t.labels[el.dataset.tLabel]; });
                document.getElementById('welcomeTitle').textContent = t.title;
                document.getElementById('welcomeUser').textContent = `${t.op}: ${currentUser}`;
                document.getElementById('logoutBtn').textContent = t.logout;
                document.getElementById('searchInput').placeholder = t.search;
                document.getElementById('addWeaponBtn').textContent = t.add;
                document.getElementById('btnSave').textContent = t.btnSave;
                document.querySelectorAll('.tag-option').forEach(tag => { tag.textContent = t.modes[tag.dataset.mode]; });
                document.getElementById('btnConfirmDelete').textContent = t.btnConfirm;
                document.getElementById('btnCancelDelete').textContent = t.btnCancel;
                
                // Âà∑Êñ∞Ë°®Ê†º‰ª•Â∫îÁî®Ë°®Â§¥ÂíåÂÜÖÂÆπ
                renderTable();
            };
            
            // Êï∞ÊçÆÂ≠òÂÇ®
            let weapons = [];
            let currentSort = { key: 'name', direction: 'asc' };

            // --- Êï∞ÊçÆËé∑Âèñ ---
            const fetchWeapons = async () => {
                try {
                    const response = await fetch('/api/weapons', { headers: { 'X-Username': currentUser }});
                    if (!response.ok) throw new Error('Failed to retrieve data');
                    weapons = (await response.json()).weapons;
                    renderTable();
                } catch (error) { console.error(error); }
            };

            // Ê∏≤ÊüìÂºÄÁÅ´Ê®°ÂºèÊ†áÁ≠æ
            const renderFiringModes = (modeString) => {
                if (!modeString || typeof modeString !== 'string') return '';
                const modes = modeString.replace(/[{}]/g, '').split(',').map(m => m.trim().toLowerCase());
                return modes.map(mode => {
                    if (!mode) return '';
                    return `<span class="mode-tag ${mode}">${t.modes[mode] || mode}</span>`
                }).join(' ');
            };

            // --- Ë°®Ê†ºÊ∏≤Êüì ---
            const renderTable = () => {
                let displayWeapons = [...weapons].filter(w => w.name.toLowerCase().includes(searchInput.value.toLowerCase()));
                displayWeapons.sort((a, b) => {
                    const valA = a[currentSort.key]; const valB = b[currentSort.key];
                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                
                // Êõ¥Êñ∞ÊéíÂ∫èÂõæÊ†á
                document.querySelectorAll('.header-cell').forEach(c => c.classList.remove('asc', 'desc'));
                const activeHeader = document.querySelector(`.header-cell[data-sort="${currentSort.key}"]`);
                if(activeHeader) activeHeader.classList.add(currentSort.direction);

                // Ê∏ÖÁ©∫ÊóßË°å
                gridContainer.querySelectorAll('.grid-row').forEach(row => row.remove());

                const fragment = document.createDocumentFragment();
                displayWeapons.forEach(weapon => {
                    const row = document.createElement('div');
                    row.className = 'grid-row';
                    row.innerHTML = `
                        <div class="grid-cell" data-label="name"><div class="cell-content"><strong>${weapon.name}</strong></div></div>
                        <div class="grid-cell" data-mobile-label="${t.colDmg}"><div class="cell-content"><span>${weapon.damage}</span><div class="stat-bar"><div class="stat-fill" style="width: ${Math.min(weapon.damage, 100)}%"></div></div></div></div>
                        <div class="grid-cell" data-mobile-label="${t.colMode}"><div class="cell-content firing-mode-tags">${renderFiringModes(weapon.firing_mode)}</div></div>
                        <div class="grid-cell" data-mobile-label="${t.colCap}"><div class="cell-content">${weapon.capacity}</div></div>
                        <div class="grid-cell" data-mobile-label="${t.colMags}"><div class="cell-content">${weapon.mag_count}</div></div>
                        <div class="grid-cell" data-mobile-label="${t.colAmmo}" style="color:${weapon.ammo_in_mag / weapon.capacity < 0.3 ? 'var(--danger)' : 'inherit'}"><div class="cell-content">${weapon.ammo_in_mag}</div></div>
                        <div class="grid-cell actions">
                            <button class="btn btn-edit" data-name="${weapon.name}">${t.btnEdit}</button>
                            <button class="btn btn-delete" data-name="${weapon.name}">‚úï</button>
                        </div>
                    `;
                    fragment.appendChild(row);
                });
                gridContainer.appendChild(fragment);
            };

            // --- ÂºπÁ™óÈÄªËæë ---
            const openModal = (modal, data = null) => {
                if (modal === weaponModal) {
                    const weapon = data;
                    document.getElementById('weaponForm').reset();
                    document.getElementById('modalTitle').textContent = weapon ? t.modalEdit : t.modalAdd;
                    document.getElementById('originalName').value = weapon ? weapon.name : '';
                    document.querySelectorAll('.tag-option').forEach(tag => tag.classList.remove('active'));
                    document.querySelectorAll('#weaponForm input').forEach(input => hideError(input));

                    if (weapon) {
                        document.getElementById('name').value = weapon.name;
                        document.getElementById('damage').value = weapon.damage;
                        document.getElementById('capacity').value = weapon.capacity;
                        document.getElementById('mag_count').value = weapon.mag_count;
                        document.getElementById('ammo_in_mag').value = weapon.ammo_in_mag;
                        if (weapon.firing_mode) {
                            weapon.firing_mode.replace(/[{}]/g, '').split(',').forEach(m => {
                                const tag = document.querySelector(`.tag-option[data-mode="${m.trim().toLowerCase()}"]`);
                                if (tag) tag.classList.add('active');
                            });
                        }
                    }
                } else if (modal === confirmModal) {
                    document.getElementById('confirmText').textContent = data.text;
                }
                modal.style.display = 'block';
            };

            const closeModal = (modal) => modal.style.display = 'none';

            // --- È™åËØÅÈÄªËæë ---
            const showError = (input, msg) => {
                input.classList.add('error');
                const tooltip = input.parentElement.querySelector('.pubg-tooltip');
                if (tooltip) {
                    tooltip.textContent = msg || (input.type === 'number' ? t.errors.number : t.errors.required);
                    tooltip.classList.add('visible');
                    setTimeout(() => {
                        if (document.activeElement !== input) tooltip.classList.remove('visible');
                    }, 2000);
                }
            };

            const hideError = (input) => {
                input.classList.remove('error');
                const tooltip = input.parentElement.querySelector('.pubg-tooltip');
                if (tooltip) tooltip.classList.remove('visible');
            };

            const validateInput = (input) => {
                if (!input.checkValidity()) {
                    showError(input);
                    return false;
                }
                hideError(input);
                return true;
            };

            // --- ‰∫ã‰ª∂ÁõëÂê¨Âô® ---
            document.querySelectorAll('#weaponForm input').forEach(input => {
                input.addEventListener('input', () => validateInput(input));
                input.addEventListener('blur', () => hideError(input));
                if (input.type === 'number') {
                    input.addEventListener('keydown', (e) => {
                        const isControl = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter'].includes(e.key);
                        const isNumber = /^[0-9]$/.test(e.key);
                        if (!isNumber && !isControl) {
                            e.preventDefault();
                            showError(input, t.errors.number);
                        }
                    });
                }
            });

            document.getElementById('addWeaponBtn').addEventListener('click', () => openModal(weaponModal));
            
            document.getElementById('logoutBtn').addEventListener('click', () => {
                openModal(confirmModal, { text: t.confirmLogout });
                document.getElementById('btnConfirmDelete').onclick = () => {
                    localStorage.removeItem('loggedInUser');
                    window.location.href = '/login';
                };
            });

            searchInput.addEventListener('input', renderTable);
            
            langSwitcher.addEventListener('click', () => {
                const targetLang = currentLang === 'zh' ? 'en' : 'zh';
                const targetLoadingText = i18n[targetLang].errors.loading;
                loaderText.textContent = targetLoadingText; 
                langLoader.classList.add('active');
                
                setTimeout(() => {
                    currentLang = targetLang;
                    localStorage.setItem('lang', currentLang);
                    applyTranslations();
                    setTimeout(() => {
                        langLoader.classList.remove('active');
                    }, 500);
                }, 400);
            });
            
            [weaponModal, confirmModal].forEach(modal => {
                modal.querySelector('.close')?.addEventListener('click', () => closeModal(modal));
                modal.querySelector('.btn-cancel')?.addEventListener('click', () => closeModal(modal));
            });
            window.addEventListener('click', e => { if (e.target === weaponModal || e.target === confirmModal) closeModal(e.target); });

            document.getElementById('tableHeader').addEventListener('click', e => {
                const headerCell = e.target.closest('.header-cell');
                if (headerCell && headerCell.dataset.sort) {
                    const sortKey = headerCell.dataset.sort;
                    currentSort.key === sortKey ? (currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc') : (currentSort.key = sortKey, currentSort.direction = 'asc');
                    renderTable();
                }
            });

            document.getElementById('firingModeSelector').addEventListener('click', e => {
                if (e.target.classList.contains('tag-option')) {
                    e.target.classList.toggle('active');
                }
            });

            document.getElementById('weaponForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                let isValid = true;
                document.querySelectorAll('#weaponForm input').forEach(input => {
                    if (!validateInput(input)) isValid = false;
                });
                if (!isValid) return;

                const originalName = document.getElementById('originalName').value;
                const selectedModes = Array.from(document.querySelectorAll('#firingModeSelector .tag-option.active')).map(tag => tag.dataset.mode);
                const weaponData = {
                    name: document.getElementById('name').value,
                    damage: parseFloat(document.getElementById('damage').value),
                    firing_mode: `{${selectedModes.join(', ')}}`,
                    capacity: parseInt(document.getElementById('capacity').value),
                    mag_count: parseInt(document.getElementById('mag_count').value),
                    ammo_in_mag: parseInt(document.getElementById('ammo_in_mag').value)
                };
                try {
                    const response = await fetch(originalName ? `/api/weapons/${originalName}` : '/api/weapons', {
                        method: originalName ? 'PUT' : 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Username': currentUser },
                        body: JSON.stringify(weaponData)
                    });
                    if (!response.ok) throw new Error('Error');
                    closeModal(weaponModal);
                    fetchWeapons();
                } catch (error) { alert(error.message); }
            });

            gridContainer.addEventListener('click', async (e) => {
                const weaponName = e.target.dataset.name;
                if (e.target.classList.contains('btn-edit')) {
                    const weapon = weapons.find(w => w.name === weaponName);
                    if (weapon) openModal(weaponModal, weapon);
                } else if (e.target.classList.contains('btn-delete')) {
                    openModal(confirmModal, { text: `${t.confirmDel} " ${weaponName} "?` });
                    document.getElementById('btnConfirmDelete').onclick = async () => {
                        try {
                            const response = await fetch(`/api/weapons/${weaponName}`, { method: 'DELETE', headers: { 'X-Username': currentUser }});
                            if (response.ok) fetchWeapons(); else throw new Error('Delete failed');
                        } catch (error) { alert(error.message); }
                        closeModal(confirmModal);
                    };
                }
            });

            window.addEventListener('scroll', () => {
                if (window.scrollY > 100) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
            });
            backToTopBtn.addEventListener('click', () => window.scrollTo(0, 0));

            // --- Êû™Â£∞ËØÜÂà´Ê®°ÂùóÊ†∏ÂøÉÈÄªËæë ---

            const populateSelect = (selectEl, options, selectedOption) => {
                selectEl.innerHTML = '';
                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = option;
                    opt.selected = option === selectedOption;
                    selectEl.appendChild(opt);
                });
            };

            const renderBenchmarkChart = () => {
                if (benchmarkChart) benchmarkChart.destroy();

                const targetColors = {
                    weapon: 'rgba(236, 100, 166, 0.6)', // Pink
                    distance: 'rgba(106, 153, 222, 0.6)', // Blue
                    direction: 'rgba(93, 211, 158, 0.6)' // Green
                };
                const highlightColor = 'rgba(242, 169, 0, 1)';

                const selectedModels = {
                    weapon: weaponSelect.value,
                    distance: distanceSelect.value,
                    direction: directionSelect.value
                };
                
                const sortOrder = ['weapon', 'distance', 'direction'];
                sortedData = [...benchmarkData].sort((a, b) => {
                    return sortOrder.indexOf(a.target) - sortOrder.indexOf(b.target);
                });

                const chartData = {
                    labels: sortedData.map(d => d.model),
                    datasets: [{
                        label: t.rec[currentMetric === 'accuracy' ? 'acc' : 'f1'],
                        data: sortedData.map(d => d[currentMetric]),
                        backgroundColor: sortedData.map(d => targetColors[d.target] || 'rgba(200, 200, 200, 0.6)'),
                        borderColor: sortedData.map(d => (d.model === selectedModels[d.target]) ? highlightColor : 'rgba(0,0,0,0)'),
                        borderWidth: sortedData.map(d => (d.model === selectedModels[d.target]) ? 3 : 1)
                    }]
                };

                benchmarkChart = new Chart(benchmarkChartCanvas, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, max: 1.0, ticks: { color: 'white' } },
                            x: { ticks: { color: 'white', autoSkip: false, maxRotation: 90, minRotation: 45 } }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const elementIndex = elements[0].index;
                                const clickedModelData = sortedData[elementIndex];
                                if (!clickedModelData) return;

                                const { model, target } = clickedModelData;
                                const selectElement = document.getElementById(`${target}_model_select`);
                                
                                if (selectElement && selectElement.value !== model) {
                                    selectElement.value = model;
                                    handleModelChange(selectElement);
                                    
                                    const selectedModels = {
                                        weapon: weaponSelect.value,
                                        distance: distanceSelect.value,
                                        direction: directionSelect.value
                                    };
                                    
                                    benchmarkChart.data.datasets[0].borderColor = sortedData.map(d => (d.model === selectedModels[d.target]) ? highlightColor : 'rgba(0,0,0,0)');
                                    benchmarkChart.data.datasets[0].borderWidth = sortedData.map(d => (d.model === selectedModels[d.target]) ? 3 : 1);
                                    benchmarkChart.update('none');
                                }
                            }
                        },
                        onHover: (event, chartElement) => {
                            const canvas = event.native.target;
                            canvas.style.cursor = chartElement[0] ? 'pointer' : 'default';
                        }
                    }
                });
            };

            const initRecognitionModule = async () => {
                try {
                    const [modelsRes, benchmarkRes, weaponsRes] = await Promise.all([
                        fetch('/api/models'),
                        fetch('/api/benchmark'),
                        fetch('/api/weapons', { headers: { 'X-Username': currentUser }})
                    ]);
                    
                    availableModels = await modelsRes.json();
                    benchmarkData = await benchmarkRes.json();
                    const playerData = await weaponsRes.json();
                    const userPreferences = playerData.model_preferences || {};

                    populateSelect(weaponSelect, availableModels.weapon, userPreferences.weapon);
                    populateSelect(distanceSelect, availableModels.distance, userPreferences.distance);
                    populateSelect(directionSelect, availableModels.direction, userPreferences.direction);
                    
                    renderBenchmarkChart();

                } catch (error) {
                    console.error("Error initializing recognition module:", error);
                }
            };

            const handleFileUpload = async (file) => {
                // Êõ¥Êñ∞‰∏ä‰º†Âå∫ÂüüÊñáÊú¨
                uploadArea.querySelector('.upload-text').textContent = file.name;

                const formData = new FormData();
                formData.append('audio', file);
                formData.append('weapon_model', weaponSelect.value);
                formData.append('distance_model', distanceSelect.value);
                formData.append('direction_model', directionSelect.value);

                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                resultWeapon.textContent = resultDistance.textContent = resultDirection.textContent = '...';

                try {
                    const response = await fetch('/api/recognize', {
                        method: 'POST',
                        headers: { 'X-Username': currentUser },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        resultWeapon.textContent = data.results.weapon;
                        resultDistance.textContent = data.results.distance;
                        resultDirection.textContent = data.results.direction;
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('Recognition failed:', error);
                    resultWeapon.textContent = resultDistance.textContent = resultDirection.textContent = 'Error';
                }
            };
            
            // --- Êû™Â£∞ËØÜÂà´Ê®°Âùó‰∫ã‰ª∂ÁõëÂê¨ ---

            // ‰øùÂ≠òÊ®°ÂûãÂÅèÂ•Ω
            const handleModelChange = async (changedSelectElement) => {
                const preferences = {
                    weapon: weaponSelect.value,
                    distance: distanceSelect.value,
                    direction: directionSelect.value
                };
                try {
                    await fetch('/api/preferences', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Username': currentUser },
                        body: JSON.stringify(preferences)
                    });
                    const modelToPreload = changedSelectElement.value;
                    await fetch('/api/preload_model', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Username': currentUser },
                        body: JSON.stringify({ model_name: modelToPreload })
                    });
                } catch (error) {
                    console.error('Failed to save preferences or preload model:', error);
                }
            };
            
            [weaponSelect, distanceSelect, directionSelect].forEach(select => {
                select.addEventListener('change', async () => {
                    await handleModelChange(select);
                    renderBenchmarkChart();
                });
            });

            // ÂàáÊç¢ Benchmark ÊåáÊ†á
            chartControls.addEventListener('click', (e) => {
                if (e.target.classList.contains('chart-toggle-btn')) {
                    currentMetric = e.target.dataset.metric;
                    chartControls.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderBenchmarkChart();
                }
            });

            // Êñá‰ª∂‰∏ä‰º†
            uploadArea.addEventListener('click', () => audioUploadInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            audioUploadInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
            
            // ÂàùÂßãÂåñ
            applyTranslations();
            fetchWeapons();
            initRecognitionModule();
        });
    </script>
</body>
</html>